#= depend_on_asset "list-of-events.html"
#= depend_on_asset "show-selected-event.html"
#= depend_on_asset "list-of-members.html"
#= depend_on_asset "list-of-payments.html"
#= depend_on_asset "payments-chart.html"

#= depend_on_asset "new-payment-form.html"

(function() { 
  'use strict';
  var app = angular.module('weOWhatApp', ['chartjs', 'ui.bootstrap']); 
  app.controller('EventController', ["$scope", "$http", function($scope, $http, $modal) {

    $scope.events = [];
    $scope.newEvent = false;

    $http.get("/events.json").success(function(data){
      $scope.events = data;
    })

    $scope.selectEvent = function(event){
      $scope.selectedEvent = event;
      
      $http.get("/event_users/"+ event.id +".json").success(function(data){
        $scope.members = data;
      })

      $http.get("/event_payments/"+ event.id +".json").success(function(data){
        $scope.payments = data;
        console.log($scope.payments)
        var payments_made = 0;

        for( var i = 0 ; i < $scope.payments.length; i++) {
          var users = [];
          $scope.members.filter(function(value, index, ar) {
            if(value.id == $scope.payments[i].user_id) {
              users.push($scope.members[index]) 
            } 
          })
          $scope.payments[i].users = users

          payments_made += $scope.payments[i].amount
        }
        $scope.payments_total = payments_made;
        $scope.event_id = event.id;
      })

      $http.get("/event_payments_by_user/"+ event.id +".json").success(function(data){
        $scope.someData = data;
      })
    }

    $scope.someOptions = {
      segementStrokeWidth: 20,
      percentageInnerCutout: 50,
      animateRotate: true
    };

    $scope.clearSelectedEvent = function(){
      $scope.selectedEvent = false;
    }
  }]);

app.directive('listOfEvents', function() { 
  return { 
    restrict: 'C', 
    templateUrl: "<%= asset_path('list-of-events.html') %>"
  } 
})
app.directive('showSelectedEvent', function() { 
  return { 
    restrict: 'C', 
    templateUrl: "<%= asset_path('show-selected-event.html') %>"
  } 
}) 
app.directive('listOfMembers', function() { 
  return { 
    restrict: 'C', 
    templateUrl: "<%= asset_path('list-of-members.html') %>"
  } 
}) 

app.directive('listOfPayments', function() { 
  return { 
    restrict: 'C', 
    templateUrl: "<%= asset_path('list-of-payments.html') %>"
  } 
}) 

app.directive('paymentsChart', function() { 
  return { 
    restrict: 'C', 
    templateUrl: "<%= asset_path('payments-chart.html') %>"
  } 
}) 

app.directive('newPayment', function(){

  return {
      restrict: 'C',
      templateUrl: "<%= asset_path('new-payment-form.html') %>"
  }
})

app.controller('ModalDemoCtrl' , function ($scope, $modal, $log) {

  $scope.open = function (event_id) {

    var modalInstance = $modal.open({
      templateUrl: "<%= asset_path('new-payment-form.html') %>",
      controller: 'ModalInstanceCtrl',
      resolve: {
        items: function () {
          return $scope.event_id;
        }
      }
    });

    modalInstance.result.then(function (selectedItem) {
      $scope.selected = selectedItem;
    }, function () {
      $log.info('Modal dismissed at: ' + new Date());
    });
  };
});

// Please note that $modalInstance represents a modal window (instance) dependency.
// It is not the same as the $modal service used above.

app.controller('ModalInstanceCtrl', function ($scope, $modalInstance, items) {

  $scope.event_id = items;
  // $scope.selected = {
  //   item: $scope.items[0]
  // };
  console.log($scope.event_id)

  $scope.ok = function () {
    $modalInstance.close($scope.selected.item);
  };

  $scope.cancel = function () {
    $modalInstance.dismiss('cancel');
  };
});
})();
